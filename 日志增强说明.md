# 📝 日志增强说明

## 🎯 问题

数据库操作正常，但邮件没有发送，日志也没有相关信息。

---

## ✅ 已完成的修改

### 1. 增强日志输出

在以下关键位置添加了详细的日志：

#### `email_notification.py`

**初始化阶段**:
```python
[邮件初始化] OUTLOOK_AVAILABLE=True
[邮件初始化] _is_email_enabled()=True
[邮件初始化] sender_email=bohan.zhang1@audi.com.cn
✓✓✓ [邮件初始化] 邮件功能已启用
```

**发送条件检查** (`should_send_email`):
```python
[邮件检查] 开始检查 request_id=...
[邮件检查] ✓ request_id包含'batch_import'
[邮件检查] ✓ operation是TRANSACTION
[邮件检查] metadata存在: ['username', 'hostname', 'to_list', ...]
[邮件检查] ✓ to_list存在: user@company.com
[邮件检查] 检查operations: 共3个操作
[邮件检查] 操作1: type=UPDATE, table=tickets
[邮件检查] ✓ 找到tickets表的UPDATE操作
[邮件检查] ✓✓✓ 满足所有邮件发送条件！
```

**批量处理** (`process_batch_import_request`):
```python
[邮件发送] ======== 开始处理邮件发送 request_id=... ========
[邮件发送] 提取到的problem_no列表: ['10521211']
[邮件发送] 正在处理 problem_no=10521211
[邮件发送] 票据数据获取成功，准备发送邮件...
[邮件发送] ✓ problem_no 10521211 邮件发送成功
[邮件发送] ======== 邮件发送完成：成功 1/1 ========
```

**邮件发送** (`send_notification_email`):
```python
[邮件发送-10521211] to_list_str='user@company.com'
[邮件发送-10521211] cc_list_str='manager@company.com'
[邮件发送-10521211] 解析后to_emails=['user@company.com']
[邮件发送-10521211] 解析后cc_emails=['manager@company.com']
[邮件发送-10521211] 正在创建Outlook应用...
[邮件发送-10521211] Outlook应用创建成功
[邮件发送-10521211] 邮件对象创建成功
[邮件发送-10521211] 发件人: bohan.zhang1@audi.com.cn
[邮件发送-10521211] 收件人: user@company.com
[邮件发送-10521211] 抄送人: manager@company.com
[邮件发送-10521211] 主题: Ticket Update Notification: 10521211 - ...
[邮件发送-10521211] 邮件正文已设置
[邮件发送-10521211] 正在发送邮件...
[邮件发送-10521211] ✓✓✓ 邮件发送成功！
```

#### `syncsys_core.py`

**处理器调用邮件发送**:
```python
[处理器] 数据库操作状态: SUCCESS
[处理器] email_sender存在: True
[处理器] 数据库操作成功，检查是否需要发送邮件...
[处理器] 满足邮件发送条件，开始发送邮件...
[处理器] 已处理batch_import邮件发送: request_id
```

---

### 2. 创建诊断工具

**文件**: `debug_email_sending.py`

**功能**:
- ✅ 检查win32com模块
- ✅ 检查配置文件
- ✅ 检查测试请求格式
- ✅ 测试数据库连接
- ✅ 测试邮件发送器初始化
- ✅ 测试Outlook连接
- ✅ 测试数据库查询
- ✅ 生成诊断报告

**使用方法**:
```bash
python3 debug_email_sending.py
```

---

### 3. 创建排查指南

**文件**: `邮件发送问题排查指南.md`

**内容**:
- 🔍 快速诊断步骤
- 📋 常见问题检查清单
- 🛠️ 具体解决方案
- 💡 调试技巧
- 📝 实际测试步骤

---

## 🚀 如何使用

### 步骤1: 运行诊断工具

```bash
cd /workspace
python3 debug_email_sending.py
```

这会显示系统状态和潜在问题。

---

### 步骤2: 查看日志

重启处理器，然后查看日志：

```bash
# 方法1: 实时查看邮件相关日志
tail -f syncsys.log | grep -E "\[邮件|\[处理器\]"

# 方法2: 查看最近的邮件日志
grep -E "\[邮件|\[处理器\]" syncsys.log | tail -50
```

---

### 步骤3: 根据日志排查

现在日志会清楚地显示：

#### 场景1: 邮件功能未启用
```
✗✗✗ [邮件初始化] 邮件功能已禁用：Outlook不可用或配置禁用
```
→ 安装pywin32或修改配置

#### 场景2: 不满足发送条件
```
[邮件检查] request_id不包含'batch_import': USER_normal_123
```
→ 修改request_id格式

```
[邮件检查] ✗ metadata中没有有效的to_list
```
→ 添加metadata.to_list

```
[邮件检查] ✗ 没有找到tickets表的UPDATE操作
```
→ 添加对tickets表的UPDATE操作

#### 场景3: 满足条件但发送失败
```
[邮件发送-10521211] 正在创建Outlook应用...
[邮件发送-10521211] ✗✗✗ 发送邮件失败: [COM错误信息]
```
→ 检查Outlook安装和配置

---

## 📊 日志级别对比

### 修改前
```
INFO:root:处理请求 USER_batch_import_123 完成
```
看不出是否尝试发送邮件。

### 修改后
```
INFO:root:[处理器] 数据库操作状态: SUCCESS
INFO:root:[处理器] email_sender存在: True
INFO:root:[处理器] 数据库操作成功，检查是否需要发送邮件...
INFO:root:[邮件检查] 开始检查 request_id=USER_batch_import_123
INFO:root:[邮件检查] ✓ request_id包含'batch_import'
INFO:root:[邮件检查] ✓ operation是TRANSACTION
INFO:root:[邮件检查] metadata存在: ['username', 'hostname', 'to_list', 'cc_list', 'generated_at']
INFO:root:[邮件检查] ✓ to_list存在: user@company.com
INFO:root:[邮件检查] 检查operations: 共3个操作
INFO:root:[邮件检查] 操作1: type=UPDATE, table=tickets
INFO:root:[邮件检查] ✓ 找到tickets表的UPDATE操作
INFO:root:[邮件检查] ✓✓✓ 满足所有邮件发送条件！
INFO:root:[处理器] 满足邮件发送条件，开始发送邮件...
INFO:root:[邮件发送] ======== 开始处理邮件发送 request_id=USER_batch_import_123 ========
INFO:root:[邮件发送] 提取到的problem_no列表: ['10521211']
INFO:root:[邮件发送] 正在处理 problem_no=10521211
INFO:root:[邮件发送] 票据数据获取成功，准备发送邮件...
INFO:root:[邮件发送-10521211] to_list_str='user@company.com'
INFO:root:[邮件发送-10521211] 解析后to_emails=['user@company.com']
INFO:root:[邮件发送-10521211] 正在创建Outlook应用...
INFO:root:[邮件发送-10521211] Outlook应用创建成功
INFO:root:[邮件发送-10521211] 正在发送邮件...
INFO:root:[邮件发送-10521211] ✓✓✓ 邮件发送成功！
INFO:root:[处理器] 已处理batch_import邮件发送: USER_batch_import_123
INFO:root:处理请求 USER_batch_import_123 完成
```

现在可以清楚看到每一步！

---

## 🔍 快速排查命令

```bash
# 1. 查看邮件初始化
grep "\[邮件初始化\]" syncsys.log | tail -5

# 2. 查看最近的邮件检查
grep "\[邮件检查\]" syncsys.log | tail -20

# 3. 查看邮件发送过程
grep "\[邮件发送" syncsys.log | tail -30

# 4. 查看错误
grep "✗✗✗" syncsys.log | tail -10

# 5. 查看成功
grep "✓✓✓" syncsys.log | tail -10
```

---

## 📁 新增文件

| 文件 | 说明 |
|------|------|
| `debug_email_sending.py` | 诊断工具脚本 |
| `邮件发送问题排查指南.md` | 详细排查指南 |
| `日志增强说明.md` | 本文档 |

---

## ✅ 下一步

1. **重启处理器**
   ```bash
   # 停止当前处理器
   # 然后重新启动
   python3 start_processor.py
   ```

2. **发送测试请求**
   放一个batch_import请求到requests文件夹

3. **实时查看日志**
   ```bash
   tail -f syncsys.log | grep -E "\[邮件|\[处理器\]"
   ```

4. **根据日志信息排查**
   参考 `邮件发送问题排查指南.md`

---

## 💡 小贴士

- 使用 `✓✓✓` 和 `✗✗✗` 符号可以快速定位成功和失败
- 每个日志都带有 `[邮件xxx]` 或 `[处理器]` 前缀，方便过滤
- problem_no会显示在日志中，便于追踪特定票据

---

**现在重新运行处理器，日志会告诉你到底发生了什么！🔍**
