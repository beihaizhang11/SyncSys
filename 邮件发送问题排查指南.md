# ğŸ“§ é‚®ä»¶å‘é€é—®é¢˜æ’æŸ¥æŒ‡å—

## ğŸ” é—®é¢˜æè¿°

æ•°æ®åº“æ“ä½œæ­£å¸¸ï¼Œä½†é‚®ä»¶æ²¡æœ‰å‘é€ï¼Œæ—¥å¿—ä¹Ÿæ²¡æœ‰æ˜¾ç¤ºé‚®ä»¶å‘é€ç›¸å…³ä¿¡æ¯ã€‚

---

## ğŸ› ï¸ å¿«é€Ÿè¯Šæ–­

### æ­¥éª¤1: è¿è¡Œè¯Šæ–­å·¥å…·

```bash
python3 debug_email_sending.py
```

è¿™ä¸ªå·¥å…·ä¼šæ£€æŸ¥ï¼š
- âœ… win32comæ¨¡å—æ˜¯å¦å¯ç”¨
- âœ… é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®
- âœ… æµ‹è¯•è¯·æ±‚æ ¼å¼æ˜¯å¦æ­£ç¡®
- âœ… æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
- âœ… é‚®ä»¶å‘é€å™¨æ˜¯å¦åˆå§‹åŒ–
- âœ… Outlookæ˜¯å¦å¯ç”¨

---

### æ­¥éª¤2: æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

ä¿®æ”¹åçš„ä»£ç å·²ç»æ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œç°åœ¨è¿è¡Œå¤„ç†å™¨ä¼šæ˜¾ç¤ºï¼š

```
[é‚®ä»¶åˆå§‹åŒ–] OUTLOOK_AVAILABLE=True
[é‚®ä»¶åˆå§‹åŒ–] _is_email_enabled()=True
[é‚®ä»¶åˆå§‹åŒ–] sender_email=bohan.zhang1@audi.com.cn
âœ“âœ“âœ“ [é‚®ä»¶åˆå§‹åŒ–] é‚®ä»¶åŠŸèƒ½å·²å¯ç”¨

[å¤„ç†å™¨] æ•°æ®åº“æ“ä½œçŠ¶æ€: SUCCESS
[å¤„ç†å™¨] email_senderå­˜åœ¨: True
[å¤„ç†å™¨] æ•°æ®åº“æ“ä½œæˆåŠŸï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦å‘é€é‚®ä»¶...

[é‚®ä»¶æ£€æŸ¥] å¼€å§‹æ£€æŸ¥ request_id=USER_batch_import_123
[é‚®ä»¶æ£€æŸ¥] âœ“ request_idåŒ…å«'batch_import'
[é‚®ä»¶æ£€æŸ¥] âœ“ operationæ˜¯TRANSACTION
[é‚®ä»¶æ£€æŸ¥] metadataå­˜åœ¨: ['username', 'hostname', 'to_list', 'cc_list', 'generated_at']
[é‚®ä»¶æ£€æŸ¥] âœ“ to_listå­˜åœ¨: user@company.com
[é‚®ä»¶æ£€æŸ¥] æ£€æŸ¥operations: å…±3ä¸ªæ“ä½œ
[é‚®ä»¶æ£€æŸ¥] æ“ä½œ1: type=UPDATE, table=tickets
[é‚®ä»¶æ£€æŸ¥] âœ“ æ‰¾åˆ°ticketsè¡¨çš„UPDATEæ“ä½œ
[é‚®ä»¶æ£€æŸ¥] âœ“âœ“âœ“ æ»¡è¶³æ‰€æœ‰é‚®ä»¶å‘é€æ¡ä»¶ï¼

[é‚®ä»¶å‘é€] ======== å¼€å§‹å¤„ç†é‚®ä»¶å‘é€ request_id=USER_batch_import_123 ========
[é‚®ä»¶å‘é€] æå–åˆ°çš„problem_noåˆ—è¡¨: ['10521211']
[é‚®ä»¶å‘é€] æ­£åœ¨å¤„ç† problem_no=10521211
[é‚®ä»¶å‘é€] ç¥¨æ®æ•°æ®è·å–æˆåŠŸï¼Œå‡†å¤‡å‘é€é‚®ä»¶...
[é‚®ä»¶å‘é€-10521211] to_list_str='user@company.com'
[é‚®ä»¶å‘é€-10521211] cc_list_str='manager@company.com'
[é‚®ä»¶å‘é€-10521211] è§£æåto_emails=['user@company.com']
[é‚®ä»¶å‘é€-10521211] è§£æåcc_emails=['manager@company.com']
[é‚®ä»¶å‘é€-10521211] æ­£åœ¨åˆ›å»ºOutlookåº”ç”¨...
[é‚®ä»¶å‘é€-10521211] Outlookåº”ç”¨åˆ›å»ºæˆåŠŸ
[é‚®ä»¶å‘é€-10521211] é‚®ä»¶å¯¹è±¡åˆ›å»ºæˆåŠŸ
[é‚®ä»¶å‘é€-10521211] å‘ä»¶äºº: bohan.zhang1@audi.com.cn
[é‚®ä»¶å‘é€-10521211] æ”¶ä»¶äºº: user@company.com
[é‚®ä»¶å‘é€-10521211] æŠ„é€äºº: manager@company.com
[é‚®ä»¶å‘é€-10521211] ä¸»é¢˜: Ticket Update Notification: 10521211 - ...
[é‚®ä»¶å‘é€-10521211] é‚®ä»¶æ­£æ–‡å·²è®¾ç½®
[é‚®ä»¶å‘é€-10521211] æ­£åœ¨å‘é€é‚®ä»¶...
[é‚®ä»¶å‘é€-10521211] âœ“âœ“âœ“ é‚®ä»¶å‘é€æˆåŠŸï¼
```

---

## ğŸ” å¸¸è§é—®é¢˜æ£€æŸ¥æ¸…å•

### é—®é¢˜1: çœ‹ä¸åˆ°ä»»ä½•é‚®ä»¶ç›¸å…³æ—¥å¿—

**å¯èƒ½åŸå› **:
- request_idä¸åŒ…å«"batch_import"
- operationä¸æ˜¯"TRANSACTION"
- metadataä¸­æ²¡æœ‰to_list
- æ²¡æœ‰å¯¹ticketsè¡¨çš„UPDATEæ“ä½œ

**æ£€æŸ¥æ–¹æ³•**:
```bash
# æŸ¥çœ‹æ—¥å¿—ä¸­çš„é‚®ä»¶æ£€æŸ¥ä¿¡æ¯
grep "\[é‚®ä»¶æ£€æŸ¥\]" syncsys.log

# å¦‚æœæ²¡æœ‰è¾“å‡ºï¼Œè¯´æ˜æ²¡æœ‰è¿›å…¥é‚®ä»¶æ£€æŸ¥æµç¨‹
```

**è§£å†³æ–¹æ³•**:
ç¡®ä¿è¯·æ±‚æ ¼å¼æ­£ç¡®ï¼š
```json
{
  "request_id": "USER_batch_import_123456_abc",  â† å¿…é¡»åŒ…å«"batch_import"
  "operation": "TRANSACTION",                     â† å¿…é¡»æ˜¯TRANSACTION
  "data": {
    "operations": [
      {
        "type": "UPDATE",                         â† å¿…é¡»æœ‰UPDATE
        "table": "tickets",                       â† å¿…é¡»æ˜¯ticketsè¡¨
        "data": {
          "values": {...},
          "where": {"problem_no": "10521211"}
        }
      }
    ]
  },
  "metadata": {
    "to_list": "user@company.com"                 â† å¿…é¡»æœ‰to_list
  }
}
```

---

### é—®é¢˜2: æ—¥å¿—æ˜¾ç¤º"é‚®ä»¶åŠŸèƒ½å·²ç¦ç”¨"

**æ—¥å¿—å†…å®¹**:
```
âœ—âœ—âœ— [é‚®ä»¶åˆå§‹åŒ–] é‚®ä»¶åŠŸèƒ½å·²ç¦ç”¨ï¼šOutlookä¸å¯ç”¨æˆ–é…ç½®ç¦ç”¨
```

**å¯èƒ½åŸå› **:
1. win32comæ¨¡å—æœªå®‰è£…
2. config.jsonä¸­email.enabledä¸ºfalse

**æ£€æŸ¥æ–¹æ³•**:
```bash
# æ£€æŸ¥win32com
python3 -c "import win32com.client; print('OK')"

# æ£€æŸ¥é…ç½®
cat config.json | grep -A 5 "email"
```

**è§£å†³æ–¹æ³•**:

æ–¹æ³•1: å®‰è£…pywin32
```bash
pip install pywin32
```

æ–¹æ³•2: ä¿®æ”¹é…ç½®æ–‡ä»¶
```json
{
  "email": {
    "enabled": true,  â† ç¡®ä¿ä¸ºtrue
    "sender": "your-email@company.com"
  }
}
```

---

### é—®é¢˜3: æ—¥å¿—æ˜¾ç¤º"ä¸æ»¡è¶³é‚®ä»¶å‘é€æ¡ä»¶"

**æ—¥å¿—å†…å®¹**:
```
[å¤„ç†å™¨] ä¸æ»¡è¶³é‚®ä»¶å‘é€æ¡ä»¶
```

**æ£€æŸ¥æ–¹æ³•**:
æŸ¥çœ‹è¯¦ç»†çš„é‚®ä»¶æ£€æŸ¥æ—¥å¿—ï¼š
```bash
grep "\[é‚®ä»¶æ£€æŸ¥\]" syncsys.log | tail -20
```

ä¼šæ˜¾ç¤ºå…·ä½“å“ªä¸ªæ¡ä»¶ä¸æ»¡è¶³ï¼Œä¾‹å¦‚ï¼š
```
[é‚®ä»¶æ£€æŸ¥] âœ— metadataä¸­æ²¡æœ‰æœ‰æ•ˆçš„to_list
```

**è§£å†³æ–¹æ³•**:
æ ¹æ®æ—¥å¿—æç¤ºä¿®æ”¹è¯·æ±‚æ ¼å¼ã€‚

---

### é—®é¢˜4: æ—¥å¿—æ˜¾ç¤º"æœªæ‰¾åˆ°problem_no"

**æ—¥å¿—å†…å®¹**:
```
[é‚®ä»¶å‘é€] æå–åˆ°çš„problem_noåˆ—è¡¨: []
[é‚®ä»¶å‘é€] æœªæ‰¾åˆ°problem_noï¼Œè·³è¿‡é‚®ä»¶å‘é€
```

**å¯èƒ½åŸå› **:
UPDATEæ“ä½œçš„whereå­å¥ä¸­æ²¡æœ‰problem_noå­—æ®µ

**æ£€æŸ¥æ–¹æ³•**:
æ£€æŸ¥è¯·æ±‚ä¸­çš„UPDATEæ“ä½œï¼š
```json
{
  "type": "UPDATE",
  "table": "tickets",
  "data": {
    "values": {...},
    "where": {
      "problem_no": "10521211"  â† å¿…é¡»æœ‰è¿™ä¸ªå­—æ®µ
    }
  }
}
```

---

### é—®é¢˜5: æ—¥å¿—æ˜¾ç¤º"æœªæ‰¾åˆ°ç¥¨æ®æ•°æ®"

**æ—¥å¿—å†…å®¹**:
```
[é‚®ä»¶å‘é€] æœªæ‰¾åˆ°problem_no 10521211 çš„ç¥¨æ®æ•°æ®
```

**å¯èƒ½åŸå› **:
æ•°æ®åº“ä¸­ä¸å­˜åœ¨è¯¥problem_noçš„è®°å½•

**æ£€æŸ¥æ–¹æ³•**:
```bash
sqlite3 /path/to/database.db "SELECT * FROM tickets WHERE problem_no='10521211'"
```

**è§£å†³æ–¹æ³•**:
ç¡®ä¿æ•°æ®åº“ä¸­æœ‰å¯¹åº”çš„ç¥¨æ®è®°å½•ã€‚

---

### é—®é¢˜6: åˆ›å»ºOutlookåº”ç”¨å¤±è´¥

**æ—¥å¿—å†…å®¹**:
```
[é‚®ä»¶å‘é€-10521211] æ­£åœ¨åˆ›å»ºOutlookåº”ç”¨...
[é‚®ä»¶å‘é€-10521211] âœ—âœ—âœ— å‘é€é‚®ä»¶å¤±è´¥: ...
```

**å¯èƒ½åŸå› **:
1. Outlookæœªå®‰è£…
2. Outlookæœªæ­£ç¡®é…ç½®
3. COMç»„ä»¶åˆå§‹åŒ–å¤±è´¥

**æ£€æŸ¥æ–¹æ³•**:
```bash
# æ‰‹åŠ¨æµ‹è¯•Outlook
python3 -c "
import win32com.client as win32
import pythoncom
pythoncom.CoInitialize()
outlook = win32.Dispatch('outlook.application')
print('Outlook OK')
"
```

**è§£å†³æ–¹æ³•**:
1. ç¡®ä¿Outlookå·²å®‰è£…
2. æ‰“å¼€Outlookè‡³å°‘ä¸€æ¬¡ï¼Œå®Œæˆåˆå§‹é…ç½®
3. ç¡®ä¿è¿è¡Œç”¨æˆ·æœ‰Outlookè®¿é—®æƒé™

---

## ğŸ“ å®é™…æµ‹è¯•æ­¥éª¤

### 1. å‡†å¤‡æµ‹è¯•è¯·æ±‚

åˆ›å»ºæ–‡ä»¶ `test_batch_import_request.json`:
```json
{
  "request_id": "TEST_batch_import_1234567890_abc",
  "client_id": "TEST_CLIENT",
  "operation": "TRANSACTION",
  "table": "",
  "data": {
    "operations": [
      {
        "type": "UPDATE",
        "table": "tickets",
        "data": {
          "values": {
            "comments": "æµ‹è¯•é‚®ä»¶å‘é€"
          },
          "where": {
            "problem_no": "10521211"
          }
        }
      }
    ]
  },
  "timestamp": 1704355200.0,
  "metadata": {
    "username": "TEST_USER",
    "hostname": "TEST_HOST",
    "to_list": "your-test-email@company.com",
    "cc_list": "",
    "generated_at": "2025-01-04T10:00:00"
  }
}
```

### 2. æ”¾å…¥è¯·æ±‚æ–‡ä»¶å¤¹

```bash
# å¤åˆ¶åˆ°requestsæ–‡ä»¶å¤¹
cp test_batch_import_request.json /path/to/requests/
```

### 3. è§‚å¯Ÿæ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f syncsys.log | grep -E "\[é‚®ä»¶|\[å¤„ç†å™¨\]"
```

### 4. æ£€æŸ¥ç»“æœ

- âœ… å¦‚æœçœ‹åˆ° `âœ“âœ“âœ“ é‚®ä»¶å‘é€æˆåŠŸï¼` - é‚®ä»¶å·²å‘é€
- âŒ å¦‚æœçœ‹åˆ°é”™è¯¯ä¿¡æ¯ - æ ¹æ®é”™è¯¯æç¤ºæ’æŸ¥

---

## ğŸ”§ è°ƒè¯•æŠ€å·§

### 1. æé«˜æ—¥å¿—çº§åˆ«

åœ¨`config.json`ä¸­ï¼š
```json
{
  "logging": {
    "level": "DEBUG",  â† æ”¹ä¸ºDEBUGæŸ¥çœ‹æ›´å¤šä¿¡æ¯
    "file": "syncsys.log"
  }
}
```

### 2. å•ç‹¬æµ‹è¯•é‚®ä»¶åŠŸèƒ½

```python
from email_notification import TicketEmailSender
from syncsys_core import DatabaseManager, ConfigManager

# åˆå§‹åŒ–
config = ConfigManager('config.json')
db_manager = DatabaseManager(config.get('database.path'))
sender = TicketEmailSender(db_manager, config)

# æµ‹è¯•è¯·æ±‚
import json
with open('test_request.json') as f:
    request = json.load(f)

# æ£€æŸ¥æ¡ä»¶
print("Should send:", sender.should_send_email(request))

# å°è¯•å‘é€
sender.process_batch_import_request(request)
```

### 3. æ£€æŸ¥Outlook

æ‰“å¼€Outlookï¼ŒæŸ¥çœ‹ï¼š
- ğŸ“§ å‘ä»¶ç®±ï¼ˆOutboxï¼‰- é‚®ä»¶æ˜¯å¦å¡åœ¨è¿™é‡Œ
- ğŸ“§ å·²å‘é€é‚®ä»¶ï¼ˆSent Itemsï¼‰- é‚®ä»¶æ˜¯å¦å·²å‘é€
- âš ï¸ æ˜¯å¦æœ‰å®‰å…¨æç¤º

---

## ğŸ“‹ å®Œæ•´æ£€æŸ¥æ¸…å•

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤é€é¡¹æ£€æŸ¥ï¼š

```bash
# 1. æ£€æŸ¥win32com
python3 -c "import win32com.client; print('âœ“ win32com OK')"

# 2. æ£€æŸ¥é…ç½®
cat config.json | grep -A 3 '"email"'

# 3. æ£€æŸ¥æ•°æ®åº“
ls -lh /path/to/database.db

# 4. è¿è¡Œè¯Šæ–­å·¥å…·
python3 debug_email_sending.py

# 5. æ£€æŸ¥æ—¥å¿—
tail -100 syncsys.log | grep -E "\[é‚®ä»¶|\[å¤„ç†å™¨\]"

# 6. æµ‹è¯•Outlook
python3 -c "
import win32com.client as win32
import pythoncom
pythoncom.CoInitialize()
outlook = win32.Dispatch('outlook.application')
mail = outlook.CreateItem(0)
print('âœ“ Outlook OK')
"
```

---

## ğŸ’¡ å¸¸è§è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: é‡å¯Outlook
```bash
# Windows
taskkill /F /IM OUTLOOK.EXE
# ç„¶åé‡æ–°æ‰“å¼€Outlook
```

### æ–¹æ¡ˆ2: é‡æ–°åˆå§‹åŒ–COM
```python
import pythoncom
pythoncom.CoUninitialize()
pythoncom.CoInitialize()
```

### æ–¹æ¡ˆ3: æ£€æŸ¥æƒé™
ç¡®ä¿Pythonè„šæœ¬æœ‰æƒé™è®¿é—®Outlook

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœæ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ä½†ä»ç„¶æ— æ³•å‘é€é‚®ä»¶ï¼Œè¯·ï¼š

1. è¿è¡Œè¯Šæ–­å·¥å…·å¹¶ä¿å­˜è¾“å‡ºï¼š
   ```bash
   python3 debug_email_sending.py > debug_output.txt 2>&1
   ```

2. æå–ç›¸å…³æ—¥å¿—ï¼š
   ```bash
   grep -E "\[é‚®ä»¶|\[å¤„ç†å™¨\]" syncsys.log > email_logs.txt
   ```

3. æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
   - debug_output.txt
   - email_logs.txt
   - è¯·æ±‚JSONæ–‡ä»¶
   - Windowsç‰ˆæœ¬
   - Outlookç‰ˆæœ¬

---

**ç¥æ‚¨æ’æŸ¥é¡ºåˆ©ï¼ğŸš€**
