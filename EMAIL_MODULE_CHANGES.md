# é‚®ä»¶å‘é€æ¨¡å—ä¿®æ”¹è¯´æ˜

## ğŸ“‹ ä¿®æ”¹æ¦‚è¿°

æœ¬æ¬¡ä¿®æ”¹å°†é‚®ä»¶å‘é€æ¨¡å—ä»åŸºäºé¢„å®šä¹‰çš„`assignee`é‚®ç®±æ˜ å°„æ”¹ä¸ºä»è¯·æ±‚çš„`metadata`ä¸­åŠ¨æ€è¯»å–æ”¶ä»¶äººå’ŒæŠ„é€äººåˆ—è¡¨ã€‚

## ğŸ”„ ä¸»è¦å˜æ›´

### 1. **ç§»é™¤é¢„å®šä¹‰çš„é‚®ç®±æ˜ å°„**
   - âŒ åˆ é™¤äº† `ASSIGNEE_EMAILS` å­—å…¸ï¼ˆ7ä¸ªé¢„å®šä¹‰é‚®ç®±ï¼‰
   - âŒ åˆ é™¤äº† `get_assignee_email()` æ–¹æ³•

### 2. **æ–°å¢é‚®ä»¶åˆ—è¡¨è§£æåŠŸèƒ½**
   - âœ… æ–°å¢ `parse_email_list()` æ–¹æ³•
   - æ”¯æŒè§£æåˆ†å·åˆ†éš”çš„é‚®ä»¶åˆ—è¡¨ï¼š`"1@1.com;2@2.com"`
   - è‡ªåŠ¨å»é™¤ç©ºæ ¼å’Œç©ºå­—ç¬¦ä¸²

### 3. **ä¿®æ”¹é‚®ä»¶å‘é€é€»è¾‘**
   
   #### `should_send_email()` æ–¹æ³•
   - æ–°å¢æ£€æŸ¥ï¼š`metadata` ä¸­å¿…é¡»å­˜åœ¨éç©ºçš„ `to_list`
   - å¦‚æœæ²¡æœ‰ `to_list`ï¼Œä¸å‘é€é‚®ä»¶

   #### `send_notification_email()` æ–¹æ³•
   - ä» `metadata.to_list` è¯»å–æ”¶ä»¶äººåˆ—è¡¨
   - ä» `metadata.cc_list` è¯»å–æŠ„é€äººåˆ—è¡¨
   - æ”¯æŒå¤šä¸ªæ”¶ä»¶äººå’ŒæŠ„é€äºº
   - æ—¥å¿—è®°å½•åŒ…å«å®Œæ•´çš„æ”¶ä»¶äººå’ŒæŠ„é€äººåˆ—è¡¨

### 4. **æ›´æ–°é‚®ä»¶å†…å®¹æ¨¡æ¿**
   
   #### é‚®ä»¶ä¸»é¢˜
   - ä½¿ç”¨ `short_text` æ›¿ä»£åŸæ¥çš„ `title` å­—æ®µ
   
   #### é‚®ä»¶æ­£æ–‡
   - é—®å€™è¯­æ”¹ä¸ºé€šç”¨çš„ "Dear Team"ï¼ˆä¸å†ä½¿ç”¨ assignee åç§°ï¼‰
   - æ›´æ–°å…ƒæ•°æ®éƒ¨åˆ†æ˜¾ç¤ºï¼š
     - `username`: æ¥è‡ª `metadata.username`
     - `Update time`: æ¥è‡ª `metadata.generated_at`
     - `Hostname`: æ¥è‡ª `metadata.hostname`

### 5. **ç®€åŒ–æ‰¹é‡å¤„ç†é€»è¾‘**
   
   #### `process_batch_import_request()` æ–¹æ³•
   - âŒ ç§»é™¤äº† assignee æ£€æŸ¥é€»è¾‘
   - ä¸å†åˆ¤æ–­ç¥¨æ®æ˜¯å¦æœ‰ assignee
   - åªè¦ç¥¨æ®å­˜åœ¨å°±å‘é€é‚®ä»¶

## ğŸ“ æ–°çš„è¯·æ±‚æ ¼å¼

```json
{
  "request_id": "VB5SEZF_batch_import_1754890750_187u4ebn",
  "client_id": "CICNBJSCLAU0363",
  "operation": "TRANSACTION",
  "table": "",
  "data": {
    "operations": [
      {
        "type": "UPDATE",
        "table": "tickets",
        "data": {
          "values": {
            "comments": "abc"
          },
          "where": {
            "problem_no": "10521211"
          }
        }
      }
    ]
  },
  "timestamp": 1754890751.0116744,
  "metadata": {
    "username": "VB5SEZF",
    "hostname": "CICNBJSCLAU0363",
    "to_list": "1@1.com;2@2.com",      // æ”¶ä»¶äººåˆ—è¡¨
    "cc_list": "3@3.com;4@4.com",      // æŠ„é€äººåˆ—è¡¨
    "generated_at": "2025-08-11T13:39:11.011677"
  }
}
```

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### é‚®ä»¶åˆ—è¡¨æ ¼å¼
- **åˆ†éš”ç¬¦**: åˆ†å· (`;`)
- **ç¤ºä¾‹**: `"email1@company.com;email2@company.com;email3@company.com"`
- **è‡ªåŠ¨å¤„ç†**: å»é™¤å‰åç©ºæ ¼ã€è¿‡æ»¤ç©ºå­—ç¬¦ä¸²

### æ”¶ä»¶äººè®¾ç½®
- **To**: å¿…å¡«ï¼Œä» `metadata.to_list` è¯»å–
- **CC**: å¯é€‰ï¼Œä» `metadata.cc_list` è¯»å–
- **å¤šäººæ”¯æŒ**: æ”¯æŒä»»æ„æ•°é‡çš„æ”¶ä»¶äººå’ŒæŠ„é€äºº

### è§¦å‘æ¡ä»¶
é‚®ä»¶å‘é€éœ€è¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š
1. âœ… é‚®ä»¶åŠŸèƒ½å·²å¯ç”¨ï¼ˆOutlook å¯ç”¨ï¼‰
2. âœ… `request_id` åŒ…å« `"batch_import"`
3. âœ… `operation` ä¸º `"TRANSACTION"`
4. âœ… `metadata.to_list` å­˜åœ¨ä¸”éç©º
5. âœ… åŒ…å«å¯¹ `tickets` è¡¨çš„ `UPDATE` æ“ä½œ

## ğŸ”§ é…ç½®è¯´æ˜

`config.json` ä¸­çš„é‚®ä»¶é…ç½®ï¼š

```json
{
  "email": {
    "enabled": true,
    "sender": "bohan.zhang1@audi.com.cn",
    "batch_import_notifications": true,
    "smtp_timeout": 30
  }
}
```

## ğŸ“Š å…¼å®¹æ€§è¯´æ˜

### å‘åå…¼å®¹æ€§
- âš ï¸ **ä¸å…¼å®¹**: æ—§æ ¼å¼ä¾èµ– `assignee` å­—æ®µçš„è¯·æ±‚å°†æ— æ³•å‘é€é‚®ä»¶
- âœ… **æ–°æ ¼å¼**: å¿…é¡»åœ¨ `metadata` ä¸­æä¾› `to_list`

### è¿ç§»æŒ‡å—
å¦‚æœæ‚¨çš„ç³»ç»Ÿæ­£åœ¨ä»æ—§ç‰ˆæœ¬è¿ç§»ï¼š
1. ç¡®ä¿æ‰€æœ‰ batch_import è¯·æ±‚åœ¨ `metadata` ä¸­åŒ…å« `to_list`
2. å¯é€‰ï¼šæ·»åŠ  `cc_list` ç”¨äºæŠ„é€
3. ç¡®ä¿é‚®ç®±åœ°å€æ ¼å¼æ­£ç¡®ï¼Œä½¿ç”¨åˆ†å·åˆ†éš”

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯ä¿®æ”¹ï¼š

```bash
python3 test_email_module.py
```

æµ‹è¯•å†…å®¹åŒ…æ‹¬ï¼š
- âœ… é‚®ä»¶åˆ—è¡¨è§£æåŠŸèƒ½
- âœ… metadata è¯»å–
- âœ… problem_no æå–
- âœ… å‘é€æ¡ä»¶åˆ¤æ–­

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

- **ä¸»è¦æ–‡ä»¶**: `email_notification.py`
- **æµ‹è¯•æ–‡ä»¶**: `test_email_module.py` (æ–°å¢)
- **æµ‹è¯•æ•°æ®**: `test_request.json` (å·²å­˜åœ¨)

## ğŸ¯ ä¿®æ”¹ä¼˜åŠ¿

1. **æ›´çµæ´»**: æ”¶ä»¶äººç”±è¯·æ±‚åŠ¨æ€æŒ‡å®šï¼Œä¸å—é¢„å®šä¹‰åˆ—è¡¨é™åˆ¶
2. **å¯æ‰©å±•**: æ”¯æŒä»»æ„æ•°é‡çš„æ”¶ä»¶äººå’ŒæŠ„é€äºº
3. **æ›´é€šç”¨**: ä¸å†ä¾èµ–ç‰¹å®šçš„ä¸šåŠ¡å­—æ®µï¼ˆassigneeï¼‰
4. **æ˜“ç»´æŠ¤**: æ— éœ€åœ¨ä»£ç ä¸­ç»´æŠ¤é‚®ç®±æ˜ å°„è¡¨

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£ã€‚

---
**ä¿®æ”¹æ—¥æœŸ**: 2025-01-04
**ä¿®æ”¹äºº**: AI Assistant
**ç‰ˆæœ¬**: 2.0
